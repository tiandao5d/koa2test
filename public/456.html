<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="./js/jsSHA.js"></script>
  </head>
  <body>
    <button onclick="btnclick()">aa</button>
    <script>
      let userInfo = {
        token:
          "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1ODkzMzE1ODQsImlhdCI6MTU4OTI0NTE4NCwibmJmIjoxNTg5MjQ1MTg0LCJpZGVudGl0eSI6Inh1bGluIn0.0cep6V0ByCchhA32TIRUhH0IZpXAbak2X6kzMAPFIfI",
        secrets: "IQxm9SWgmYaUpakRq4Nj6lnvwZYe9Yiw",
      };
      let method = "POST";
      let url =
        "https://dev-api.leap.localgravity.com.cn/layers/global_icl_public_transports/_search";
      let data = {
        search: null,
        filter: {
          lgl_sku: [],
          icl_status: ["open", "planned", "construction", "potential"],
          lgl_category: [],
          lgl_format: [],
          geo3_id: [],
          bbox: [
            113.91320631014342,
            22.482041363852503,
            114.155535825397,
            22.638985399850966,
          ],
        },
        coord_sys: "gww",
        offset: 0,
        sort: null,
        size: 50,
        aggs: "point",
        with_names: false,
      };

      function btnclick() {
        let options = {
          method,
          url,
          data,
          responseType: "arraybuffer",
        };
        axios(options)
          // axios({url: '/user'})
          .then((res) => {
            responseFormat(res);
            console.log("res: =======", res);
          })
          .catch((res) => {
            console.log("err: =======", res);
          });
      }
      axios.interceptors.request.use(
        function (config) {
          let userInfo = {
            token:
              "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE1ODkzMzE1ODQsImlhdCI6MTU4OTI0NTE4NCwibmJmIjoxNTg5MjQ1MTg0LCJpZGVudGl0eSI6Inh1bGluIn0.0cep6V0ByCchhA32TIRUhH0IZpXAbak2X6kzMAPFIfI",
            secrets: "IQxm9SWgmYaUpakRq4Nj6lnvwZYe9Yiw",
          };
          let headers = config.headers || {};
          let method = config.method;
          let token = userInfo.token;
          let secrets = userInfo.secrets;
          let url = config.url;

          headers = Object.assign(
            {},
            getHeaders({ url, token, secrets, method }),
            headers
          );
          config.headers = headers;
          config.timeout = 20000;
          return config;
        },
        function (err) {
          return Promise.reject(err);
        }
      );
      axios.interceptors.response.use(
        function (response) {
          response = responseFormat(response);
          return response;
        },
        function (err) {
          return Promise.reject(err);
        }
      );

      function getHeaders({ url, token, secrets, method } = optoins) {
        method = method.toLocaleUpperCase();
        let headers = {
          Authorization: "Bearer " + token,
          "X-Request-From": 1,
        };
        let currentTimestamp = Math.floor(Date.now() / 1000);
        let shaObj = new jsSHA("SHA-256", "TEXT");
        let hmac = null;
        let urlObj = new URL(url);
        shaObj.setHMACKey(secrets, "TEXT");
        shaObj.update(`${method} ${urlObj.pathname} ${currentTimestamp}`);
        hmac = shaObj.getHMAC("HEX");
        headers["LG-Timestamp"] = currentTimestamp;
        headers["LG-Content-Sig"] = hmac;
        return headers;
      }
      function arrayBuffer2Str(arrayBuffer) {
        let result = "",
          len = arrayBuffer.length,
          start = 0,
          end = 0,
          bufferSize = Math.pow(2, 8) - 1;
        for (; start < len; start += bufferSize) {
          end = start + bufferSize;
          end = end > len ? len : end;
          result += String.fromCharCode.apply(
            null,
            arrayBuffer.subarray(start, end)
          );
        }
        return result;
      }

      function decode(buffer) {
        let data = new Uint8Array(buffer);

        let binaryString = "";
        for (var i = 0; i < data.byteLength; i++) {
          data[i] = ~data[i];
          binaryString = String.fromCharCode(data[i]) + binaryString;
        }
        return decodeURIComponent(escape(binaryString));
      }

      function responseFormat(response) {
        let r = null;
        let data = response.data;
        let config = response.config || {};
        let responseType =
          config.responseType && config.responseType.toLocaleLowerCase();
        let headers = config.headers || {};
        let contentType = (headers["Content-Type"] || "").toLocaleLowerCase();
        if (responseType === "arraybuffer") {
          if (contentType.includes("application/x.lgde")) {
            r = decode(data);
            r = JSON.parse(r);
          } else if (contentType.includes("application/json")) {
            r = arrayBuffer2Str(new Uint8Array(data));
            r = JSON.parse(r);
          } else if (contentType.includes("image/jpeg")) {
            r = data;
          } else {
            r = String.fromCharCode.apply(null, new Uint8Array(data));
          }
        }
        response.data = r;
        return response;
      }

      btnclick();
    </script>
  </body>
</html>
